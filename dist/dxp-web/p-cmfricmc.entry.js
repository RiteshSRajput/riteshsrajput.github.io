import{r as t,d as s,h as e,g as i}from"./p-8188e849.js";import{B as a}from"./p-16d6f0ca.js";import{m as h}from"./p-55c24ce5.js";const n=class{constructor(s){t(this,s),this.apiResult=[],this.avgStars=[],this.feedbackListArray=[],this.feedbackListDisplay=[],this.starCountArray=[],this.feedbackItemList=[],this.reviewsLimit=10,this.usernameKeyLocation="COOKIE"}componentWillLoad(){this.base=new a(this,s),this.base.i18Init(s,"Feedback",h),this.stepCount=this.reviewsLimit,this.isSubmitDisabled=!0}async componentDidLoad(){this.feedbackItemList&&this.feedbackDataChangeHandler(),this.feedbackListDisplay&&this.feedbackDataDisplay(),await this.loadFeedBack()}componentDidUpdate(){this.showAverageStars()}emittedFeedback(t){this.feedbackListArray.find(s=>s.ratingId===t.detail.feedbackId)?this.feedbackListArray=this.feedbackListArray.map(s=>s.ratingId===t.detail.feedbackId?Object.assign(Object.assign({},s),{ratingValue:t.detail.feedbackValue}):s):this.feedbackListArray.push({ratingId:t.detail.feedbackId,ratingValue:t.detail.feedbackValue}),this.isSubmitDisabled=this.feedbackItemList.length!==this.feedbackListArray.length}async submitHandler(t){if("load-more"===t.target.getAttribute("btn-id")&&(this.reviewsLimit=this.reviewsLimit+this.stepCount,await this.loadFeedBack()),"cancel"===t.target.getAttribute("btn-id")&&this.clearFeedbackForm(),"submit"===t.target.getAttribute("btn-id")){this.loadMoreElement&&(this.loadMoreElement.style.display="none"),this.itemContainerDisplay&&(this.itemContainerDisplay.innerHTML="");const t={appId:this.appId,contentId:this.contentId,ratings:this.feedbackListArray,feedback:this.textareaValue,createdBy:this.getUserName()},e={method:"POST",headers:{"Content-Type":"application/json",appId:this.appId,contentId:this.contentId},body:JSON.stringify(t)};this.textareaValue="",this.apiUrl?await this.apiService(this.apiUrl,e)&&(await this.loadFeedBack(),this.clearFeedbackForm()):(t.ratings[0]&&(Number.isInteger(t.ratings[0].ratingValue)?this.feedbackListDisplay.unshift({displayUserName:t.createdBy,starCount:Number(t.ratings[0].ratingValue),timeStamp:s.moment(new Date).fromNow(),feedbackAdditionalText:t.feedback}):this.feedbackListDisplay.unshift({displayUserName:t.createdBy,feedbackValue:t.ratings[0].ratingValue,timeStamp:s.moment(new Date).fromNow(),feedbackAdditionalText:t.feedback})),await this.loadFeedBack(),this.clearFeedbackForm())}this.isSubmitDisabled=!0}async apiService(t,e){return e&&""!==e?s.api(t,e):s.api(t)}clearFeedbackForm(){this.feedbackDataChangeHandler(),this.textAreaElement.querySelectorAll("textarea")[0].value="",this.feedbackListArray=[]}feedbackDataChangeHandler(){this.feedbackItemList&&this.feedbackItemList.length>0&&this.base.createNestedMarkup(this.itemContainer,"dxp-feedback-item",this.feedbackItemList)}feedbackDataDisplay(){this.feedbackListDisplay&&this.feedbackListDisplay.length>0&&this.base.createNestedMarkup(this.itemContainerDisplay,"dxp-feedback-display",this.feedbackListDisplay.slice(0,this.reviewsLimit))}getUserName(){let t="Anonymous";return"COOKIE"===this.usernameKeyLocation&&document.cookie.split(";").forEach(s=>{if(s.match(this.usernameKey)){const e=s.match(this.usernameKey).input.split("=");t=e[1]}}),"SESSION"===this.usernameKeyLocation&&(t=sessionStorage.getItem(this.usernameKey)),"OTHER"===this.usernameKeyLocation&&(t="Other"),t=t||"Anonymous"}handleTextarea(t){this.textareaValue=t.target.value}async loadFeedBack(){let t;const e={method:"GET",headers:{appId:this.appId,contentId:this.contentId,"Content-Type":"application/json"}};if(this.apiUrl&&1===this.feedbackItemList.length){let i;this.loadMoreElement&&(this.loadMoreElement.style.display="none"),(t=await this.apiService(this.apiUrl,e))&&t.length>0&&(i=[...t].reverse().filter(t=>t.ratings[0]).map(t=>Number.isInteger(t.ratings[0].ratingValue)?{displayUserName:t.createdBy,feedbackValue:t.ratings[0].ratingValue,timeStamp:s.moment(`${t.createdDate.replace("T"," ")}Z`).fromNow(),feedbackAdditionalText:t.feedback}:{displayUserName:t.createdBy,starCount:Number(t.ratings[0].ratingValue),feedbackValue:t.ratings[0].ratingValue,timeStamp:s.moment(`${t.createdDate.replace("T"," ")}Z`).fromNow(),feedbackAdditionalText:t.feedback})),this.feedbackListDisplay=i&&i.length>0?[...i]:[],this.avgStars=[];const a=this.feedbackListDisplay.reduce((t,s)=>Object.assign(Object.assign({},t),{[s.starCount]:1+(0|t[s.feedbackValue]),total:1+(0|t.total)}),{});for(let t=0;t<this.feedbackItemList[0]["star-count"];t++)this.avgStars.push({star:t+1,rating:0});this.avgStars.forEach(t=>{for(const s of Object.keys(a))"total"!==s&&t.star===Number(s)&&(t.rating=Math.round(a[s]/a.total*100))}),this.avgStars.sort((t,s)=>s.star-t.star)}this.feedbackDataDisplay(),this.averageDisplayElement&&this.showAverageDisplayElement(),this.countDisplayElement&&(this.countDisplayElement.innerHTML=this.feedbackListDisplay.length>0?` ${this.feedbackListDisplay.length} <span class="feedback-heading">${s.i18n.t(this.feedbackListDisplay.length>1?"Feedback:Reviews":"Feedback:Review")}</span>`:""),this.loadMoreElement&&(this.loadMoreElement.style.display=this.feedbackListDisplay.length>this.reviewsLimit?"block":"none")}renderStars(){let t="",s=!1;s=this.starFillIndex-Math.floor(this.starFillIndex)!=0,this.starFillIndex=s?Math.ceil(this.starFillIndex):Math.floor(this.starFillIndex);for(let e=1;e<=this.avgStars.length;e++)t=`${t}<span class= ${e===this.starFillIndex&&s?"half-star":e>=0&&e<=this.starFillIndex?" active ":""} custom-id={${e}} > </span>`;return t}showAverageDisplayElement(){if(1===this.feedbackItemList.length&&"star"===this.feedbackItemList[0]["display-as"]){const t=(this.feedbackListDisplay.reduce((t,s)=>(0|t)+s.starCount,0)/this.feedbackListDisplay.length).toFixed(1),e=t.split(".");e[1]&&Number(e[1])>=8?this.starFillIndex=Math.round(Number(t)):e[1]&&Number(e[1])>=3&&Number(e[1])<=7?(e.splice(1,1,"5"),this.starFillIndex=e.join(".")):this.starFillIndex=Math.round(Number(t)),this.averageDisplayElement.innerHTML=this.feedbackListDisplay.length>0?` <span class="count-display">${t}</span>\n        <div class='render-stars' role='img' aria-label= ${s.i18n.t("Feedback:star")}>  ${this.renderStars()} </div>\n        ${s.i18n.t("Feedback:basedOn")} ${this.feedbackListDisplay.length} ${s.i18n.t(this.feedbackListDisplay.length>1?"Feedback:ratings":"Feedback:rating")}.`:""}}showAverageStars(){this.avgStars.forEach((t,s)=>{this.starAverageDisplay&&this.starAverageDisplay.getElementsByClassName("average-line")[s]&&(this.starAverageDisplay.getElementsByClassName("average-line")[s].style.width=`${t.rating}%`)})}render(){const t=[e("link",{rel:"stylesheet",href:""}),[this.theme&&e("link",{rel:"stylesheet",href:""})],[this.theme&&e("link",{rel:"stylesheet",href:`${s.config.get("DXP_STYLE_BASE_URL")}/themes/${this.theme}/dxp-feedback.min.css`})]];return e("div",{class:`container ${this.base.componentClass()}`,dir:this.dir,"data-theme":this.theme},t,e("h3",{class:"feedback-title-display"},this.feedbackTitle),e("div",{class:"feedback-item-wrapper"},e("div",{class:"feedback-items",ref:t=>this.itemContainer=t},e("slot",null)),this.isAdditionalCommentRequired&&e("div",null,this.feedbackAdditionalText,e("div",{class:"textarea-wrapper"},e("dxp-textarea",{rows:3,"max-length":500,placeholder:this.feedbackAdditionalTextPlaceholder,onInput:t=>this.handleTextarea(t),ref:t=>this.textAreaElement=t}))),e("div",{class:"btn-wrapper"},e("div",{class:"submit-btn"},e("dxp-cta-list",null,e("dxp-cta",{type:"button","btn-id":"submit","button-type":"primary",text:"Submit",disabled:this.isSubmitDisabled,onClick:t=>this.submitHandler(t)}),e("dxp-cta",{type:"button","btn-id":"cancel","button-type":"secondary",text:"Cancel",onClick:t=>this.submitHandler(t)}))))),1===this.feedbackItemList.length?e("div",{class:"display-wrapper"},"star"===this.feedbackItemList[0]["display-as"]?e("div",{class:"avg-rating-wrapper"},e("div",{class:"average-rating",ref:t=>this.averageDisplayElement=t}),e("div",{class:"star-rating",ref:t=>this.starAverageDisplay=t},this.avgStars.map(t=>e("div",{class:"star-line"},e("span",null,t.star,e("i",{class:"active",role:"img","aria-label":`${s.i18n.t("Feedback:starRatedBy")} ${t.rating} ${s.i18n.t("Feedback:percentageUsers")}`})),e("div",{class:"grey-line"},e("div",{class:"average-line"})))))):"","star"!==this.feedbackItemList[0]["display-as"]?e("h3",{ref:t=>this.countDisplayElement=t}):"",e("div",{class:"feedback-display",ref:t=>this.itemContainerDisplay=t}),e("div",{class:"load-more",ref:t=>this.loadMoreElement=t},e("dxp-cta",{type:"button","btn-id":"load-more","button-type":"secondary",text:s.i18n.t("Feedback:showMoreReview"),onClick:t=>this.submitHandler(t)}))):"")}get element(){return i(this)}static get style(){return"div.dxp.dxp-feedback{padding:.93rem}div.dxp.dxp-feedback .btn-wrapper{display:-ms-flexbox;display:flex;margin-top:1.5rem}div.dxp.dxp-feedback .textarea-wrapper{margin:1rem 0}div.dxp.dxp-feedback .feedback-title-display{margin-top:1rem;margin-bottom:2rem}div.dxp.dxp-feedback .display-wrapper{margin-top:1.5rem}div.dxp.dxp-feedback .display-wrapper .average-rating{margin-bottom:2rem;width:50%}div.dxp.dxp-feedback .display-wrapper .average-rating .count-display{display:block;padding-right:1rem}div.dxp.dxp-feedback .display-wrapper .star-rating{width:50%}div.dxp.dxp-feedback .display-wrapper .star-rating span{display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;padding:0 .5rem}div.dxp.dxp-feedback .display-wrapper .star-rating .star-line{display:-ms-flexbox;display:flex;-ms-flex-pack:center;justify-content:center;-ms-flex-align:center;align-items:center;place-content:flex-end}div.dxp.dxp-feedback .display-wrapper .star-rating .star-line .grey-line{width:50%;height:.25rem}div.dxp.dxp-feedback .display-wrapper .star-rating .star-line .grey-line .average-line{width:0;height:100%;-webkit-transition:width .6s ease-out;transition:width .6s ease-out}div.dxp.dxp-feedback .display-wrapper .avg-rating-wrapper{display:-ms-flexbox;display:flex}div.dxp.dxp-feedback .display-wrapper .feedback-heading{display:inline-block}div.dxp.dxp-feedback .display-wrapper .feedback-heading:first-letter{text-transform:capitalize}div.dxp.dxp-feedback .display-wrapper .load-more{margin-bottom:1.75rem}"}};export{n as dxp_feedback};