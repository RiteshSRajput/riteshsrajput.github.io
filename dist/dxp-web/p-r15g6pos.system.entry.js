var __awaiter=this&&this.__awaiter||function(e,t,a,i){function r(e){return e instanceof a?e:new a((function(t){t(e)}))}return new(a||(a=Promise))((function(a,s){function n(e){try{o(i.next(e))}catch(t){s(t)}}function l(e){try{o(i["throw"](e))}catch(t){s(t)}}function o(e){e.done?a(e.value):r(e.value).then(n,l)}o((i=i.apply(e,t||[])).next())}))};var __generator=this&&this.__generator||function(e,t){var a={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},i,r,s,n;return n={next:l(0),throw:l(1),return:l(2)},typeof Symbol==="function"&&(n[Symbol.iterator]=function(){return this}),n;function l(e){return function(t){return o([e,t])}}function o(n){if(i)throw new TypeError("Generator is already executing.");while(a)try{if(i=1,r&&(s=n[0]&2?r["return"]:n[0]?r["throw"]||((s=r["return"])&&s.call(r),0):r.next)&&!(s=s.call(r,n[1])).done)return s;if(r=0,s)n=[n[0]&2,s.value];switch(n[0]){case 0:case 1:s=n;break;case 4:a.label++;return{value:n[1],done:false};case 5:a.label++;r=n[1];n=[0];continue;case 7:n=a.ops.pop();a.trys.pop();continue;default:if(!(s=a.trys,s=s.length>0&&s[s.length-1])&&(n[0]===6||n[0]===2)){a=0;continue}if(n[0]===3&&(!s||n[1]>s[0]&&n[1]<s[3])){a.label=n[1];break}if(n[0]===6&&a.label<s[1]){a.label=s[1];s=n;break}if(s&&a.label<s[2]){a.label=s[2];a.ops.push(n);break}if(s[2])a.ops.pop();a.trys.pop();continue}n=t.call(e,a)}catch(l){n=[6,l];r=0}finally{i=s=0}if(n[0]&5)throw n[1];return{value:n[0]?n[1]:void 0,done:true}}};var __spreadArrays=this&&this.__spreadArrays||function(){for(var e=0,t=0,a=arguments.length;t<a;t++)e+=arguments[t].length;for(var i=Array(e),r=0,t=0;t<a;t++)for(var s=arguments[t],n=0,l=s.length;n<l;n++,r++)i[r]=s[n];return i};System.register(["./p-f4cc861d.system.js","./p-4b0c1219.system.js","./p-13fc30a0.system.js"],(function(e){"use strict";var t,a,i,r,s,n;return{setters:[function(e){t=e.r;a=e.d;i=e.h;r=e.g},function(e){s=e.B},function(e){n=e.m}],execute:function(){var l="display-as";var o=e("dxp_feedback",function(){function e(e){t(this,e);this.apiResult=[];this.avgStars=[];this.feedbackListArray=[];this.feedbackListDisplay=[];this.starCountArray=[];this.feedbackItemList=[];this.reviewsLimit=10;this.usernameKeyLocation="COOKIE"}e.prototype.componentWillLoad=function(){this.base=new s(this,a);this.base.i18Init(a,"Feedback",n);this.stepCount=this.reviewsLimit;this.isSubmitDisabled=true};e.prototype.componentDidLoad=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){switch(e.label){case 0:if(this.feedbackItemList){this.feedbackDataChangeHandler()}if(this.feedbackListDisplay){this.feedbackDataDisplay()}return[4,this.loadFeedBack()];case 1:e.sent();return[2]}}))}))};e.prototype.componentDidUpdate=function(){this.showAverageStars()};e.prototype.emittedFeedback=function(e){var t=this.feedbackListArray.find((function(t){return t.ratingId===e.detail.feedbackId}));t?this.feedbackListArray=this.feedbackListArray.map((function(t){return t.ratingId===e.detail.feedbackId?Object.assign(Object.assign({},t),{ratingValue:e.detail.feedbackValue}):t})):this.feedbackListArray.push({ratingId:e.detail.feedbackId,ratingValue:e.detail.feedbackValue});this.isSubmitDisabled=this.feedbackItemList.length!==this.feedbackListArray.length?true:false};e.prototype.submitHandler=function(e){return __awaiter(this,void 0,void 0,(function(){var t,i,r;return __generator(this,(function(s){switch(s.label){case 0:if(!(e.target.getAttribute("btn-id")==="load-more"))return[3,2];this.reviewsLimit=this.reviewsLimit+this.stepCount;return[4,this.loadFeedBack()];case 1:s.sent();s.label=2;case 2:if(e.target.getAttribute("btn-id")==="cancel"){this.clearFeedbackForm()}if(!(e.target.getAttribute("btn-id")==="submit"))return[3,8];if(this.loadMoreElement){this.loadMoreElement.style.display="none"}if(this.itemContainerDisplay){this.itemContainerDisplay.innerHTML=""}t={appId:this.appId,contentId:this.contentId,ratings:this.feedbackListArray,feedback:this.textareaValue,createdBy:this.getUserName()};i={method:"POST",headers:{"Content-Type":"application/json",appId:this.appId,contentId:this.contentId},body:JSON.stringify(t)};this.textareaValue="";if(!this.apiUrl)return[3,6];return[4,this.apiService(this.apiUrl,i)];case 3:r=s.sent();if(!r)return[3,5];return[4,this.loadFeedBack()];case 4:s.sent();this.clearFeedbackForm();s.label=5;case 5:return[3,8];case 6:if(t.ratings[0]){Number.isInteger(t.ratings[0]["ratingValue"])?this.feedbackListDisplay.unshift({displayUserName:t.createdBy,starCount:Number(t.ratings[0]["ratingValue"]),timeStamp:a.moment(new Date).fromNow(),feedbackAdditionalText:t.feedback}):this.feedbackListDisplay.unshift({displayUserName:t.createdBy,feedbackValue:t.ratings[0]["ratingValue"],timeStamp:a.moment(new Date).fromNow(),feedbackAdditionalText:t.feedback})}return[4,this.loadFeedBack()];case 7:s.sent();this.clearFeedbackForm();s.label=8;case 8:this.isSubmitDisabled=true;return[2]}}))}))};e.prototype.apiService=function(e,t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(i){if(t&&t!==""){return[2,a.api(e,t)]}return[2,a.api(e)]}))}))};e.prototype.clearFeedbackForm=function(){this.feedbackDataChangeHandler();this.textAreaElement?this.textAreaElement.querySelectorAll("textarea")[0].value="":this.textAreaElement.querySelectorAll("textarea")[0].value="";this.feedbackListArray=[]};e.prototype.feedbackDataChangeHandler=function(){if(this.feedbackItemList&&this.feedbackItemList.length>0){this.base.createNestedMarkup(this.itemContainer,"dxp-feedback-item",this.feedbackItemList)}};e.prototype.feedbackDataDisplay=function(){if(this.feedbackListDisplay&&this.feedbackListDisplay.length>0){this.base.createNestedMarkup(this.itemContainerDisplay,"dxp-feedback-display",this.feedbackListDisplay.slice(0,this.reviewsLimit))}};e.prototype.getUserName=function(){var e=this;var t="Anonymous";if(this.usernameKeyLocation==="COOKIE"){var a=document.cookie.split(";");a.forEach((function(a){if(a.match(e.usernameKey)){var i=a.match(e.usernameKey).input.split("=");t=i[1]}}))}if(this.usernameKeyLocation==="SESSION"){t=sessionStorage.getItem(this.usernameKey)}if(this.usernameKeyLocation==="OTHER"){t="Other"}t=t?t:"Anonymous";return t};e.prototype.handleTextarea=function(e){this.textareaValue=e.target.value};e.prototype.loadFeedBack=function(){return __awaiter(this,void 0,void 0,(function(){var e,t,i,r,s;return __generator(this,(function(n){switch(n.label){case 0:t={method:"GET",headers:{appId:this.appId,contentId:this.contentId,"Content-Type":"application/json"}};if(!(this.apiUrl&&this.feedbackItemList.length===1))return[3,2];if(this.loadMoreElement){this.loadMoreElement.style.display="none"}return[4,this.apiService(this.apiUrl,t)];case 1:e=n.sent();i=void 0;if(e&&e.length>0){i=__spreadArrays(e).reverse().filter((function(e){return e.ratings[0]})).map((function(e){return Number.isInteger(e.ratings[0]["ratingValue"])?{displayUserName:e.createdBy,feedbackValue:e.ratings[0]["ratingValue"],timeStamp:a.moment(e.createdDate.replace("T"," ")+"Z").fromNow(),feedbackAdditionalText:e.feedback}:{displayUserName:e.createdBy,starCount:Number(e.ratings[0]["ratingValue"]),feedbackValue:e.ratings[0]["ratingValue"],timeStamp:a.moment(e.createdDate.replace("T"," ")+"Z").fromNow(),feedbackAdditionalText:e.feedback}}))}this.feedbackListDisplay=i&&i.length>0?__spreadArrays(i):[];this.avgStars=[];r=this.feedbackListDisplay.reduce((function(e,t){var a;return Object.assign(Object.assign({},e),(a={},a[t.starCount]=(e[t.feedbackValue]|0)+1,a.total=(e["total"]|0)+1,a))}),{});for(s=0;s<this.feedbackItemList[0]["star-count"];s++){this.avgStars.push({star:s+1,rating:0})}this.avgStars.forEach((function(e){for(var t=0,a=Object.keys(r);t<a.length;t++){var i=a[t];if(i!=="total"&&e.star===Number(i)){e.rating=Math.round(r[i]/r.total*100)}}}));this.avgStars.sort((function(e,t){return t.star-e.star}));n.label=2;case 2:this.feedbackDataDisplay();if(this.averageDisplayElement){this.showAverageDisplayElement()}if(this.countDisplayElement){this.countDisplayElement.innerHTML=this.feedbackListDisplay.length>0?" "+this.feedbackListDisplay.length+' <span class="feedback-heading">'+(this.feedbackListDisplay.length>1?a.i18n.t("Feedback:Reviews"):a.i18n.t("Feedback:Review"))+"</span>":""}if(this.loadMoreElement){this.loadMoreElement.style.display=this.feedbackListDisplay.length>this.reviewsLimit?"block":"none"}return[2]}}))}))};e.prototype.renderStars=function(){var e="";var t=false;t=this.starFillIndex-Math.floor(this.starFillIndex)!==0?true:false;this.starFillIndex=t?Math.ceil(this.starFillIndex):Math.floor(this.starFillIndex);for(var a=1;a<=this.avgStars.length;a++){e=e+"<span class= "+(a===this.starFillIndex&&t?"half-star":a>=0&&a<=this.starFillIndex?" active ":"")+" custom-id={"+a+"} > </span>"}return e};e.prototype.showAverageDisplayElement=function(){if(this.feedbackItemList.length===1&&this.feedbackItemList[0][l]==="star"){var e=this.feedbackListDisplay.reduce((function(e,t){return(e|0)+t.starCount}),0);var t=(e/this.feedbackListDisplay.length).toFixed(1);var i=t.split(".");if(i[1]&&Number(i[1])>=8){this.starFillIndex=Math.round(Number(t))}else if(i[1]&&Number(i[1])>=3&&Number(i[1])<=7){i.splice(1,1,"5");this.starFillIndex=i.join(".")}else{this.starFillIndex=Math.round(Number(t))}this.averageDisplayElement.innerHTML=this.feedbackListDisplay.length>0?' <span class="count-display">'+t+"</span>\n        <div class='render-stars' role='img' aria-label= "+a.i18n.t("Feedback:star")+">  "+this.renderStars()+" </div>\n        "+a.i18n.t("Feedback:basedOn")+" "+this.feedbackListDisplay.length+" "+(this.feedbackListDisplay.length>1?a.i18n.t("Feedback:ratings"):a.i18n.t("Feedback:rating"))+".":""}};e.prototype.showAverageStars=function(){var e=this;this.avgStars.forEach((function(t,a){if(e.starAverageDisplay&&e.starAverageDisplay.getElementsByClassName("average-line")[a]){e.starAverageDisplay.getElementsByClassName("average-line")[a].style.width=t.rating+"%"}}))};e.prototype.render=function(){var e=this;var t=[i("link",{rel:"stylesheet",href:""}),[this.theme&&i("link",{rel:"stylesheet",href:""})],[this.theme&&i("link",{rel:"stylesheet",href:a.config.get("DXP_STYLE_BASE_URL")+"/themes/"+this.theme+"/dxp-feedback.min.css"})]];return i("div",{class:"container "+this.base.componentClass(),dir:this.dir,"data-theme":this.theme},t,i("h3",{class:"feedback-title-display"},this.feedbackTitle),i("div",{class:"feedback-item-wrapper"},i("div",{class:"feedback-items",ref:function(t){return e.itemContainer=t}},i("slot",null)),this.isAdditionalCommentRequired&&i("div",null,this.feedbackAdditionalText,i("div",{class:"textarea-wrapper"},i("dxp-textarea",{rows:3,"max-length":500,placeholder:this.feedbackAdditionalTextPlaceholder,onInput:function(t){return e.handleTextarea(t)},ref:function(t){return e.textAreaElement=t}}))),i("div",{class:"btn-wrapper"},i("div",{class:"submit-btn"},i("dxp-cta-list",null,i("dxp-cta",{type:"button","btn-id":"submit","button-type":"primary",text:"Submit",disabled:this.isSubmitDisabled,onClick:function(t){return e.submitHandler(t)}}),i("dxp-cta",{type:"button","btn-id":"cancel","button-type":"secondary",text:"Cancel",onClick:function(t){return e.submitHandler(t)}}))))),this.feedbackItemList.length===1?i("div",{class:"display-wrapper"},this.feedbackItemList[0][l]==="star"?i("div",{class:"avg-rating-wrapper"},i("div",{class:"average-rating",ref:function(t){return e.averageDisplayElement=t}}),i("div",{class:"star-rating",ref:function(t){return e.starAverageDisplay=t}},this.avgStars.map((function(e){return i("div",{class:"star-line"},i("span",null,e.star,i("i",{class:"active",role:"img","aria-label":a.i18n.t("Feedback:starRatedBy")+" "+e.rating+" "+a.i18n.t("Feedback:percentageUsers")})),i("div",{class:"grey-line"},i("div",{class:"average-line"})))})))):"",this.feedbackItemList[0][l]!=="star"?i("h3",{ref:function(t){return e.countDisplayElement=t}}):"",i("div",{class:"feedback-display",ref:function(t){return e.itemContainerDisplay=t}}),i("div",{class:"load-more",ref:function(t){return e.loadMoreElement=t}},i("dxp-cta",{type:"button","btn-id":"load-more","button-type":"secondary",text:a.i18n.t("Feedback:showMoreReview"),onClick:function(t){return e.submitHandler(t)}}))):"")};Object.defineProperty(e.prototype,"element",{get:function(){return r(this)},enumerable:true,configurable:true});Object.defineProperty(e,"style",{get:function(){return"div.dxp.dxp-feedback{padding:.93rem}div.dxp.dxp-feedback .btn-wrapper{display:-ms-flexbox;display:flex;margin-top:1.5rem}div.dxp.dxp-feedback .textarea-wrapper{margin:1rem 0}div.dxp.dxp-feedback .feedback-title-display{margin-top:1rem;margin-bottom:2rem}div.dxp.dxp-feedback .display-wrapper{margin-top:1.5rem}div.dxp.dxp-feedback .display-wrapper .average-rating{margin-bottom:2rem;width:50%}div.dxp.dxp-feedback .display-wrapper .average-rating .count-display{display:block;padding-right:1rem}div.dxp.dxp-feedback .display-wrapper .star-rating{width:50%}div.dxp.dxp-feedback .display-wrapper .star-rating span{display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;padding:0 .5rem}div.dxp.dxp-feedback .display-wrapper .star-rating .star-line{display:-ms-flexbox;display:flex;-ms-flex-pack:center;justify-content:center;-ms-flex-align:center;align-items:center;place-content:flex-end}div.dxp.dxp-feedback .display-wrapper .star-rating .star-line .grey-line{width:50%;height:.25rem}div.dxp.dxp-feedback .display-wrapper .star-rating .star-line .grey-line .average-line{width:0;height:100%;-webkit-transition:width .6s ease-out;transition:width .6s ease-out}div.dxp.dxp-feedback .display-wrapper .avg-rating-wrapper{display:-ms-flexbox;display:flex}div.dxp.dxp-feedback .display-wrapper .feedback-heading{display:inline-block}div.dxp.dxp-feedback .display-wrapper .feedback-heading:first-letter{text-transform:capitalize}div.dxp.dxp-feedback .display-wrapper .load-more{margin-bottom:1.75rem}"},enumerable:true,configurable:true});return e}())}}}));