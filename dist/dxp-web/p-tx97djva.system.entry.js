var __awaiter=this&&this.__awaiter||function(e,t,n,r){function i(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,o){function s(e){try{m(r.next(e))}catch(t){o(t)}}function a(e){try{m(r["throw"](e))}catch(t){o(t)}}function m(e){e.done?n(e.value):i(e.value).then(s,a)}m((r=r.apply(e,t||[])).next())}))};var __generator=this&&this.__generator||function(e,t){var n={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},r,i,o,s;return s={next:a(0),throw:a(1),return:a(2)},typeof Symbol==="function"&&(s[Symbol.iterator]=function(){return this}),s;function a(e){return function(t){return m([e,t])}}function m(s){if(r)throw new TypeError("Generator is already executing.");while(n)try{if(r=1,i&&(o=s[0]&2?i["return"]:s[0]?i["throw"]||((o=i["return"])&&o.call(i),0):i.next)&&!(o=o.call(i,s[1])).done)return o;if(i=0,o)s=[s[0]&2,o.value];switch(s[0]){case 0:case 1:o=s;break;case 4:n.label++;return{value:s[1],done:false};case 5:n.label++;i=s[1];s=[0];continue;case 7:s=n.ops.pop();n.trys.pop();continue;default:if(!(o=n.trys,o=o.length>0&&o[o.length-1])&&(s[0]===6||s[0]===2)){n=0;continue}if(s[0]===3&&(!o||s[1]>o[0]&&s[1]<o[3])){n.label=s[1];break}if(s[0]===6&&n.label<o[1]){n.label=o[1];o=s;break}if(o&&n.label<o[2]){n.label=o[2];n.ops.push(s);break}if(o[2])n.ops.pop();n.trys.pop();continue}s=t.call(e,n)}catch(a){s=[6,a];i=0}finally{r=o=0}if(s[0]&5)throw s[1];return{value:s[0]?s[1]:void 0,done:true}}};var __spreadArrays=this&&this.__spreadArrays||function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;for(var r=Array(e),i=0,t=0;t<n;t++)for(var o=arguments[t],s=0,a=o.length;s<a;s++,i++)r[i]=o[s];return r};System.register(["./p-f4cc861d.system.js","./p-4b0c1219.system.js","./p-da23bd6d.system.js"],(function(e){"use strict";var t,n,r,i,o,s;return{setters:[function(e){t=e.r;n=e.d;r=e.h;i=e.g},function(e){o=e.B},function(e){s=e.m}],execute:function(){var a="is-visible";var m="handleApiResponse()";var u="Some error occurred";var c=e("dxp_comments",function(){function e(e){t(this,e);this.apiResult=[];this.domComments=[];this.stepCount=1;this.userDataContainer="COOKIE"}e.prototype.componentWillLoad=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){switch(e.label){case 0:this.base=new o(this,n);this.base.i18Init(n,"Comments",s);this.config();if(!this.apiUrl)return[3,2];return[4,this.handleApiResponse()];case 1:e.sent();return[3,4];case 2:if(!this.mockcommentUrl)return[3,4];return[4,this.handleMockResponse()];case 3:e.sent();e.label=4;case 4:return[2]}}))}))};e.prototype.clickActionMenuHandler=function(e){this.commentId=e.detail.commentId?e.detail.commentId:""};e.prototype.clickEditCommentHandler=function(e){this.editCommentId=e.detail.commentId?e.detail.commentId:""};e.prototype.clickHandler=function(){var e=this;var t=this.element.querySelectorAll("dxp-comments-with-reply");t.forEach((function(t){var n=t.querySelectorAll("dxp-comments-item");n.forEach((function(t){var n=typeof t["commentObj"]==="string"?JSON.parse(t["commentObj"]):t["commentObj"];var r=t.querySelector(".action-list-wrapper");if(r!==null){if(n.id!==e.commentId){t["isActionMenuActive"]=false;r.classList.remove(a)}else{t["isActionMenuActive"]=true;r.classList.add(a)}}var i=t.querySelector(".reply-textarea");if(n.id===e.editCommentId){i.classList.remove("dxp-none");i.classList.add("dxp-flex");t["isOpenedForEditReply"]=true;t["isOpenedForReply"]=false;t["isReplyLinkActive"]=false;i.classList.remove("reply-section")}else if(n.id===e.replyCommentId){i.classList.remove("dxp-none");i.classList.add("reply-section");t["isOpenedForEditReply"]=false;t["isOpenedForReply"]=true;t["isReplyLinkActive"]=true;i.classList.remove("dxp-flex")}else{i.classList.remove("dxp-flex");i.classList.add("dxp-none");t["isOpenedForReply"]=false;t["isOpenedForEditReply"]=false;t["isReplyLinkActive"]=false;i.classList.remove("reply-section")}}))}));this.commentId="";this.editCommentId="";this.replyCommentId=""};e.prototype.clickReplyCommentHandler=function(e){this.replyCommentId=e.detail.commentId?e.detail.commentId:""};e.prototype.routingHandler=function(e){this.base.routingEventListener(e)};e.prototype.submitHandler=function(e){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:if(!(e.target.getAttribute("btn-id")==="submitButton"))return[3,3];if(!this.commentText)return[3,2];return[4,this.handleApiResponse("add",this.commentText)];case 1:t.sent();this.commentText="";t.label=2;case 2:return[3,4];case 3:if(e.target.getAttribute("btn-id")==="load-more-comments"){this.stepCount++}t.label=4;case 4:if(this.textAreaInput&&this.textAreaInput){this.textAreaInput.querySelector("textarea").value=""}return[2]}}))}))};e.prototype.textAreaValueHandler=function(e){this.commentText=e.detail.value};e.prototype.updateCommentObj=function(e){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:if(!(e&&e.detail))return[3,12];if(!(e.detail.action==="delete"))return[3,5];if(!e.detail.isReplied)return[3,2];return[4,this.handleApiResponse("replyDelete","",e.detail.replyOf,e.detail.commentId)];case 1:t.sent();return[3,4];case 2:return[4,this.handleApiResponse("delete","",e.detail.commentId)];case 3:t.sent();t.label=4;case 4:return[3,12];case 5:if(!(e.detail.action==="edit"))return[3,10];if(!e.detail.isReplied)return[3,7];return[4,this.handleApiResponse("replyEdit",e.detail.updatedText,e.detail.replyOf,e.detail.commentId)];case 6:t.sent();return[3,9];case 7:return[4,this.handleApiResponse("edit",e.detail.updatedText,e.detail.commentId)];case 8:t.sent();t.label=9;case 9:return[3,12];case 10:if(!(e.detail.action==="reply"))return[3,12];return[4,this.handleApiResponse("replyAdd",e.detail.updatedText,e.detail.commentId)];case 11:t.sent();t.label=12;case 12:return[2]}}))}))};e.prototype.addComment=function(e){return __awaiter(this,void 0,void 0,(function(){var t,n,r,i;return __generator(this,(function(o){t={appId:this.appId,contentId:this.commentContentId,text:e,createdBy:this.userId,needsModeration:0};n=this.handleHeaders();r={method:"POST",headers:n,body:JSON.stringify(t)};i=this.apiUrl+"/comment";return[2,this.apiService(i,r)]}))}))};e.prototype.addReply=function(e,t){return __awaiter(this,void 0,void 0,(function(){var n,r,i,o;return __generator(this,(function(s){n={commentId:t,comment:{text:e,createdBy:this.userId,needsModeration:0,replyOf:t}};r=this.handleHeaders();i={method:"POST",headers:r,body:JSON.stringify(n)};o=this.apiUrl+"/reply";return[2,this.apiService(o,i)]}))}))};e.prototype.apiService=function(e,t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(r){if(t&&t!==""){return[2,n.api(e,t)]}return[2,n.api(e)]}))}))};e.prototype.config=function(){if(this.userDataContainer&&this.userDataContainer==="COOKIE"&&this.getCookie(this.useridKey)){this.userId=this.getCookie(this.useridKey);return true}if(this.userDataContainer&&this.userDataContainer==="SESSION"&&sessionStorage.getItem(this.useridKey)){this.userId=sessionStorage.getItem(this.useridKey);return true}if(this.userDataContainer&&this.userDataContainer==="OTHER"){this.userId="Other";return true}this.userId="Anonymous";return true};e.prototype.convertDate=function(e){return n.moment(e.replace("T"," ")+"Z").fromNow()};e.prototype.deleteComment=function(e){return __awaiter(this,void 0,void 0,(function(){var t,n,r,i;return __generator(this,(function(o){t={commentId:e,userId:this.userId};n=this.handleHeaders();r={method:"PUT",headers:n,body:JSON.stringify(t)};i=this.apiUrl+"/comment/delete";return[2,this.apiService(i,r)]}))}))};e.prototype.deleteReply=function(e,t){return __awaiter(this,void 0,void 0,(function(){var n,r,i,o;return __generator(this,(function(s){n={commentId:e,userId:this.userId,replyId:t};r=this.handleHeaders();i={method:"PUT",headers:r,body:JSON.stringify(n)};o=this.apiUrl+"/reply/delete";return[2,this.apiService(o,i)]}))}))};e.prototype.editComment=function(e,t){return __awaiter(this,void 0,void 0,(function(){var n,r,i,o;return __generator(this,(function(s){n={commentId:e,userId:this.userId,comment:{text:t,needsModeration:0}};r=this.handleHeaders();i={method:"PUT",headers:r,body:JSON.stringify(n)};o=this.apiUrl+"/comment";return[2,this.apiService(o,i)]}))}))};e.prototype.editReply=function(e,t,n){return __awaiter(this,void 0,void 0,(function(){var r,i,o,s;return __generator(this,(function(a){r={commentId:e,replyId:t,userId:this.userId,comment:{text:n,needsModeration:0}};i=this.handleHeaders();o={method:"PUT",headers:i,body:JSON.stringify(r)};s=this.apiUrl+"/reply";return[2,this.apiService(s,o)]}))}))};e.prototype.fetchComment=function(){return __awaiter(this,void 0,void 0,(function(){var e,t,n;return __generator(this,(function(r){e=this.handleHeaders("GET");t={method:"GET",headers:e};n=this.apiUrl+"/comment";return[2,this.apiService(n,t)]}))}))};e.prototype.getCookie=function(e){var t=e+"=";var n=document.cookie.split(";");for(var r=0,i=n;r<i.length;r++){var o=i[r];var s=o;while(s.charAt(0)===" "){s=s.substring(1,s.length)}if(s.indexOf(t)===0){return s.substring(t.length,s.length)}}return undefined};e.prototype.handleApiResponse=function(e,t,r,i){return __awaiter(this,void 0,void 0,(function(){var o=this;return __generator(this,(function(s){switch(s.label){case 0:if(!(e==="add"))return[3,2];return[4,this.addComment(t).then((function(e){o.apiResult=e;if(o.apiResult){o.apiResult["commentConvertedTime"]=o.convertDate(o.apiResult.createdDate);o.domComments=__spreadArrays([o.apiResult],o.domComments);o.commentCount=o.domComments.length}n.log.info(o.element.tagName,m,"Comment list after Add comment:",o.domComments)})).catch((function(e){n.log.error(o.element.tagName,m,u,e)}))];case 1:s.sent();return[3,14];case 2:if(!(e==="edit"))return[3,4];return[4,this.editComment(r,t).then((function(e){o.apiResult=e;if(o.apiResult){o.apiResult["commentConvertedTime"]=o.convertDate(o.apiResult.updatedDate);o.domComments=o.domComments.map((function(e){if(e.id===r){o.apiResult.replies=o.apiResult.replies.map((function(e){e["commentConvertedTime"]=o.convertDate(e.createdDate);return e}));return o.apiResult}return e}));o.commentCount=o.domComments.length;n.log.info(o.element.tagName,m,"Edit Comment list after edit comment:",o.domComments)}})).catch((function(e){n.log.error(o.element.tagName,m,u,e)}))];case 3:s.sent();return[3,14];case 4:if(!(e==="delete"))return[3,6];return[4,this.deleteComment(r).then((function(e){o.apiResult=e;if(o.apiResult){o.domComments=o.domComments.map((function(e){return e})).filter((function(e){return e.id!==r}));o.commentCount=o.domComments.length;n.log.info(o.element.tagName,m,"Comment list after delete comment:",o.domComments)}})).catch((function(e){n.log.error(o.element.tagName,m,u,e)}))];case 5:s.sent();return[3,14];case 6:if(!(e==="replyAdd"))return[3,8];return[4,this.addReply(t,r).then((function(e){o.apiResult=e;if(o.apiResult){o.apiResult["commentConvertedTime"]=o.convertDate(o.apiResult.createdDate);o.domComments=o.domComments.map((function(e){if(e.id===r){e.replies=__spreadArrays(e.replies,[o.apiResult]);return e}return e}));o.commentCount=o.domComments.length}n.log.info(o.element.tagName,m,"Comment list after Add reply:",o.domComments)})).catch((function(e){n.log.error(o.element.tagName,m,u,e)}))];case 7:s.sent();return[3,14];case 8:if(!(e==="replyEdit"))return[3,10];return[4,this.editReply(r,i,t).then((function(e){o.apiResult=e;if(o.apiResult){o.apiResult["commentConvertedTime"]=o.convertDate(o.apiResult.updatedDate);o.domComments=o.domComments.map((function(e){if(e.id===r){e.replies=e.replies.map((function(e){return e.id===i?o.apiResult:e}))}return e}));o.commentCount=o.domComments.length}n.log.info(o.element.tagName,m,"Comment list after Edit reply:",o.domComments)})).catch((function(e){n.log.error(o.element.tagName,m,u,e)}))];case 9:s.sent();return[3,14];case 10:if(!(e==="replyDelete"))return[3,12];return[4,this.deleteReply(r,i).then((function(e){o.apiResult=e;if(o.apiResult){o.domComments=o.domComments.map((function(e){if(e.id===r){e.replies=e.replies.map((function(e){return e})).filter((function(e){return e.id!==i}))}return e}));o.commentCount=o.domComments.length;n.log.info(o.element.tagName,m,"Comment list after delete reply:",o.domComments)}})).catch((function(e){n.log.error(o.element.tagName,m,u,e)}))];case 11:s.sent();return[3,14];case 12:return[4,this.fetchComment().then((function(e){o.apiResult=e;if(o.apiResult.length>0){var t=o.apiResult.map((function(e){e["commentConvertedTime"]=o.convertDate(e.updatedDate?e.updatedDate:e.createdDate);e.replies=e.replies.map((function(e){e["commentConvertedTime"]=o.convertDate(e.updatedDate?e.updatedDate:e.createdDate);return e}));return e}));t=t.reverse();o.domComments=__spreadArrays(t,o.domComments);o.commentCount=o.domComments.length}n.log.info(o.element.tagName,m,"Fetch approved comment:",o.domComments)})).catch((function(e){n.log.error(o.element.tagName,m,u,e)}))];case 13:s.sent();s.label=14;case 14:return[2]}}))}))};e.prototype.handleHeaders=function(e){var t={};t["Content-Type"]="application/json";if(e==="GET"){t["appId"]=this.appId;t["contentId"]=this.commentContentId}return t};e.prototype.handleMockResponse=function(){return __awaiter(this,void 0,void 0,(function(){var e;return __generator(this,(function(t){switch(t.label){case 0:e=this;return[4,this.apiService(this.mockcommentUrl)];case 1:e.domComments=t.sent();this.commentCount=this.domComments.length;return[2]}}))}))};e.prototype.renderList=function(e){var t=this;this.lastIndex=this.commentsLimit*this.stepCount;return e.slice(0,this.lastIndex).map((function(e){return r("dxp-comments-with-reply",{"userid-key":t.useridKey,"user-data-container":t.userDataContainer,"replies-limit":t.repliesLimit,"max-characters":t.maxCharacters,"comment-obj":JSON.stringify(e)})}))};e.prototype.render=function(){var e=this;n.log.debug(this.element.tagName,"render()","in dxp-comments render() : "+"DEVELOPMENT");var t=[r("link",{rel:"stylesheet",href:n.config.get("DXP_STYLE_BASE_URL")+"/dxp.min.css"}),[this.theme&&r("link",{rel:"stylesheet",href:n.config.get("DXP_STYLE_BASE_URL")+"/themes/"+this.theme+"/"+this.theme+".min.css"})],[this.theme&&r("link",{rel:"stylesheet",href:n.config.get("DXP_STYLE_BASE_URL")+"/themes/"+this.theme+"/dxp-comments.min.css"})]];return r("div",{class:this.base.componentClass(),dir:this.dir,"data-theme":this.theme},t,r("div",{class:"comment-count"},this.domComments.length?r("h3",null,this.commentCount," ",this.commentCount>1?n.i18n.t("Comments:multipleCommentsText"):n.i18n.t("Comments:singleCommentText")):""),r("dxp-textarea",{label:n.i18n.t("Comments:textarealabel"),ref:function(t){return e.textAreaInput=t},placeholder:this.textareaPlaceholder?this.textareaPlaceholder:n.i18n.t("Comments:commentplaceholder"),"max-length":this.maxCharacters,required:false}),r("div",{class:"comment-hint"},n.i18n.t("Comments:commentHint",{maxlength:this.maxCharacters})),r("div",{class:"editable-block"},r("dxp-cta-list",{"title-text":"",orientation:"horizontal"},r("dxp-cta",{type:"button","btn-id":"submitButton","button-type":"primary",text:this.submitText?this.submitText:n.i18n.t("Comments:submit"),onClick:function(t){return e.submitHandler(t)}}),r("dxp-cta",{type:"button","btn-id":"cancelButton","button-type":"secondary",text:this.cancelText?this.cancelText:n.i18n.t("Comments:cancel"),onClick:function(t){return e.submitHandler(t)}}))),r("div",{class:"comment-list"},this.domComments.length?this.renderList(this.domComments):"",this.lastIndex<this.commentCount&&r("dxp-cta",{type:"button","btn-id":"load-more-comments","button-type":"secondary",text:n.i18n.t("Comments:loadmoreComments"),onClick:function(t){return e.submitHandler(t)}})))};Object.defineProperty(e.prototype,"element",{get:function(){return i(this)},enumerable:true,configurable:true});Object.defineProperty(e,"style",{get:function(){return"div.dxp.dxp-comments{padding:.5rem}div.dxp.dxp-comments .editable-block{margin-top:1rem}div.dxp.dxp-comments .comment-count{margin:2rem 0;clear:both}div.dxp.dxp-comments .comment-count h3{direction:ltr;display:inline-block}div.dxp.dxp-comments .comment-hint{margin:.5rem 0}div.dxp.dxp-comments .comment-list{margin-top:1.25rem}"},enumerable:true,configurable:true});return e}())}}}));