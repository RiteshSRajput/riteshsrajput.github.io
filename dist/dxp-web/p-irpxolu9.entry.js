import{r as t,d as s,h as e,g as i}from"./p-8188e849.js";import{B as h}from"./p-16d6f0ca.js";import{m as n}from"./p-3eebf77a.js";const o="Some error occurred",a=class{constructor(s){t(this,s),this.apiResult=[],this.domComments=[],this.stepCount=1,this.userDataContainer="COOKIE"}async componentWillLoad(){this.base=new h(this,s),this.base.i18Init(s,"Comments",n),this.config(),this.apiUrl?await this.handleApiResponse():this.mockcommentUrl&&await this.handleMockResponse()}clickActionMenuHandler(t){this.commentId=t.detail.commentId?t.detail.commentId:""}clickEditCommentHandler(t){this.editCommentId=t.detail.commentId?t.detail.commentId:""}clickHandler(){this.element.querySelectorAll("dxp-comments-with-reply").forEach(t=>{t.querySelectorAll("dxp-comments-item").forEach(t=>{const s="string"==typeof t.commentObj?JSON.parse(t.commentObj):t.commentObj,e=t.querySelector(".action-list-wrapper");null!==e&&(s.id!==this.commentId?(t.isActionMenuActive=!1,e.classList.remove("is-visible")):(t.isActionMenuActive=!0,e.classList.add("is-visible")));const i=t.querySelector(".reply-textarea");s.id===this.editCommentId?(i.classList.remove("dxp-none"),i.classList.add("dxp-flex"),t.isOpenedForEditReply=!0,t.isOpenedForReply=!1,t.isReplyLinkActive=!1,i.classList.remove("reply-section")):s.id===this.replyCommentId?(i.classList.remove("dxp-none"),i.classList.add("reply-section"),t.isOpenedForEditReply=!1,t.isOpenedForReply=!0,t.isReplyLinkActive=!0,i.classList.remove("dxp-flex")):(i.classList.remove("dxp-flex"),i.classList.add("dxp-none"),t.isOpenedForReply=!1,t.isOpenedForEditReply=!1,t.isReplyLinkActive=!1,i.classList.remove("reply-section"))})}),this.commentId="",this.editCommentId="",this.replyCommentId=""}clickReplyCommentHandler(t){this.replyCommentId=t.detail.commentId?t.detail.commentId:""}routingHandler(t){this.base.routingEventListener(t)}async submitHandler(t){"submitButton"===t.target.getAttribute("btn-id")?this.commentText&&(await this.handleApiResponse("add",this.commentText),this.commentText=""):"load-more-comments"===t.target.getAttribute("btn-id")&&this.stepCount++,this.textAreaInput&&this.textAreaInput&&(this.textAreaInput.querySelector("textarea").value="")}textAreaValueHandler(t){this.commentText=t.detail.value}async updateCommentObj(t){t&&t.detail&&("delete"===t.detail.action?t.detail.isReplied?await this.handleApiResponse("replyDelete","",t.detail.replyOf,t.detail.commentId):await this.handleApiResponse("delete","",t.detail.commentId):"edit"===t.detail.action?t.detail.isReplied?await this.handleApiResponse("replyEdit",t.detail.updatedText,t.detail.replyOf,t.detail.commentId):await this.handleApiResponse("edit",t.detail.updatedText,t.detail.commentId):"reply"===t.detail.action&&await this.handleApiResponse("replyAdd",t.detail.updatedText,t.detail.commentId))}async addComment(t){const s={appId:this.appId,contentId:this.commentContentId,text:t,createdBy:this.userId,needsModeration:0},e={method:"POST",headers:this.handleHeaders(),body:JSON.stringify(s)};return this.apiService(`${this.apiUrl}/comment`,e)}async addReply(t,s){const e={commentId:s,comment:{text:t,createdBy:this.userId,needsModeration:0,replyOf:s}},i={method:"POST",headers:this.handleHeaders(),body:JSON.stringify(e)};return this.apiService(`${this.apiUrl}/reply`,i)}async apiService(t,e){return e&&""!==e?s.api(t,e):s.api(t)}config(){return this.userDataContainer&&"COOKIE"===this.userDataContainer&&this.getCookie(this.useridKey)?(this.userId=this.getCookie(this.useridKey),!0):this.userDataContainer&&"SESSION"===this.userDataContainer&&sessionStorage.getItem(this.useridKey)?(this.userId=sessionStorage.getItem(this.useridKey),!0):this.userDataContainer&&"OTHER"===this.userDataContainer?(this.userId="Other",!0):(this.userId="Anonymous",!0)}convertDate(t){return s.moment(`${t.replace("T"," ")}Z`).fromNow()}async deleteComment(t){const s={commentId:t,userId:this.userId},e={method:"PUT",headers:this.handleHeaders(),body:JSON.stringify(s)};return this.apiService(`${this.apiUrl}/comment/delete`,e)}async deleteReply(t,s){const e={commentId:t,userId:this.userId,replyId:s},i={method:"PUT",headers:this.handleHeaders(),body:JSON.stringify(e)};return this.apiService(`${this.apiUrl}/reply/delete`,i)}async editComment(t,s){const e={commentId:t,userId:this.userId,comment:{text:s,needsModeration:0}},i={method:"PUT",headers:this.handleHeaders(),body:JSON.stringify(e)};return this.apiService(`${this.apiUrl}/comment`,i)}async editReply(t,s,e){const i={commentId:t,replyId:s,userId:this.userId,comment:{text:e,needsModeration:0}},h={method:"PUT",headers:this.handleHeaders(),body:JSON.stringify(i)};return this.apiService(`${this.apiUrl}/reply`,h)}async fetchComment(){const t=this.handleHeaders("GET");return this.apiService(`${this.apiUrl}/comment`,{method:"GET",headers:t})}getCookie(t){const s=`${t}=`,e=document.cookie.split(";");for(const i of e){let t=i;for(;" "===t.charAt(0);)t=t.substring(1,t.length);if(0===t.indexOf(s))return t.substring(s.length,t.length)}}async handleApiResponse(t,e,i,h){"add"===t?await this.addComment(e).then(t=>{this.apiResult=t,this.apiResult&&(this.apiResult.commentConvertedTime=this.convertDate(this.apiResult.createdDate),this.domComments=[this.apiResult,...this.domComments],this.commentCount=this.domComments.length),s.log.info(this.element.tagName,"handleApiResponse()","Comment list after Add comment:",this.domComments)}).catch(t=>{s.log.error(this.element.tagName,"handleApiResponse()",o,t)}):"edit"===t?await this.editComment(i,e).then(t=>{this.apiResult=t,this.apiResult&&(this.apiResult.commentConvertedTime=this.convertDate(this.apiResult.updatedDate),this.domComments=this.domComments.map(t=>t.id===i?(this.apiResult.replies=this.apiResult.replies.map(t=>(t.commentConvertedTime=this.convertDate(t.createdDate),t)),this.apiResult):t),this.commentCount=this.domComments.length,s.log.info(this.element.tagName,"handleApiResponse()","Edit Comment list after edit comment:",this.domComments))}).catch(t=>{s.log.error(this.element.tagName,"handleApiResponse()",o,t)}):"delete"===t?await this.deleteComment(i).then(t=>{this.apiResult=t,this.apiResult&&(this.domComments=this.domComments.map(t=>t).filter(t=>t.id!==i),this.commentCount=this.domComments.length,s.log.info(this.element.tagName,"handleApiResponse()","Comment list after delete comment:",this.domComments))}).catch(t=>{s.log.error(this.element.tagName,"handleApiResponse()",o,t)}):"replyAdd"===t?await this.addReply(e,i).then(t=>{this.apiResult=t,this.apiResult&&(this.apiResult.commentConvertedTime=this.convertDate(this.apiResult.createdDate),this.domComments=this.domComments.map(t=>t.id===i?(t.replies=[...t.replies,this.apiResult],t):t),this.commentCount=this.domComments.length),s.log.info(this.element.tagName,"handleApiResponse()","Comment list after Add reply:",this.domComments)}).catch(t=>{s.log.error(this.element.tagName,"handleApiResponse()",o,t)}):"replyEdit"===t?await this.editReply(i,h,e).then(t=>{this.apiResult=t,this.apiResult&&(this.apiResult.commentConvertedTime=this.convertDate(this.apiResult.updatedDate),this.domComments=this.domComments.map(t=>(t.id===i&&(t.replies=t.replies.map(t=>t.id===h?this.apiResult:t)),t)),this.commentCount=this.domComments.length),s.log.info(this.element.tagName,"handleApiResponse()","Comment list after Edit reply:",this.domComments)}).catch(t=>{s.log.error(this.element.tagName,"handleApiResponse()",o,t)}):"replyDelete"===t?await this.deleteReply(i,h).then(t=>{this.apiResult=t,this.apiResult&&(this.domComments=this.domComments.map(t=>(t.id===i&&(t.replies=t.replies.map(t=>t).filter(t=>t.id!==h)),t)),this.commentCount=this.domComments.length,s.log.info(this.element.tagName,"handleApiResponse()","Comment list after delete reply:",this.domComments))}).catch(t=>{s.log.error(this.element.tagName,"handleApiResponse()",o,t)}):await this.fetchComment().then(t=>{if(this.apiResult=t,this.apiResult.length>0){let t=this.apiResult.map(t=>(t.commentConvertedTime=this.convertDate(t.updatedDate?t.updatedDate:t.createdDate),t.replies=t.replies.map(t=>(t.commentConvertedTime=this.convertDate(t.updatedDate?t.updatedDate:t.createdDate),t)),t));t=t.reverse(),this.domComments=[...t,...this.domComments],this.commentCount=this.domComments.length}s.log.info(this.element.tagName,"handleApiResponse()","Fetch approved comment:",this.domComments)}).catch(t=>{s.log.error(this.element.tagName,"handleApiResponse()",o,t)})}handleHeaders(t){const s={"Content-Type":"application/json"};return"GET"===t&&(s.appId=this.appId,s.contentId=this.commentContentId),s}async handleMockResponse(){this.domComments=await this.apiService(this.mockcommentUrl),this.commentCount=this.domComments.length}renderList(t){return this.lastIndex=this.commentsLimit*this.stepCount,t.slice(0,this.lastIndex).map(t=>e("dxp-comments-with-reply",{"userid-key":this.useridKey,"user-data-container":this.userDataContainer,"replies-limit":this.repliesLimit,"max-characters":this.maxCharacters,"comment-obj":JSON.stringify(t)}))}render(){s.log.debug(this.element.tagName,"render()","in dxp-comments render() : DEVELOPMENT");const t=[e("link",{rel:"stylesheet",href:`${s.config.get("DXP_STYLE_BASE_URL")}/dxp.min.css`}),[this.theme&&e("link",{rel:"stylesheet",href:`${s.config.get("DXP_STYLE_BASE_URL")}/themes/${this.theme}/${this.theme}.min.css`})],[this.theme&&e("link",{rel:"stylesheet",href:`${s.config.get("DXP_STYLE_BASE_URL")}/themes/${this.theme}/dxp-comments.min.css`})]];return e("div",{class:this.base.componentClass(),dir:this.dir,"data-theme":this.theme},t,e("div",{class:"comment-count"},this.domComments.length?e("h3",null,this.commentCount," ",s.i18n.t(this.commentCount>1?"Comments:multipleCommentsText":"Comments:singleCommentText")):""),e("dxp-textarea",{label:s.i18n.t("Comments:textarealabel"),ref:t=>this.textAreaInput=t,placeholder:this.textareaPlaceholder?this.textareaPlaceholder:s.i18n.t("Comments:commentplaceholder"),"max-length":this.maxCharacters,required:!1}),e("div",{class:"comment-hint"},s.i18n.t("Comments:commentHint",{maxlength:this.maxCharacters})),e("div",{class:"editable-block"},e("dxp-cta-list",{"title-text":"",orientation:"horizontal"},e("dxp-cta",{type:"button","btn-id":"submitButton","button-type":"primary",text:this.submitText?this.submitText:s.i18n.t("Comments:submit"),onClick:t=>this.submitHandler(t)}),e("dxp-cta",{type:"button","btn-id":"cancelButton","button-type":"secondary",text:this.cancelText?this.cancelText:s.i18n.t("Comments:cancel"),onClick:t=>this.submitHandler(t)}))),e("div",{class:"comment-list"},this.domComments.length?this.renderList(this.domComments):"",this.lastIndex<this.commentCount&&e("dxp-cta",{type:"button","btn-id":"load-more-comments","button-type":"secondary",text:s.i18n.t("Comments:loadmoreComments"),onClick:t=>this.submitHandler(t)})))}get element(){return i(this)}static get style(){return"div.dxp.dxp-comments{padding:.5rem}div.dxp.dxp-comments .editable-block{margin-top:1rem}div.dxp.dxp-comments .comment-count{margin:2rem 0;clear:both}div.dxp.dxp-comments .comment-count h3{direction:ltr;display:inline-block}div.dxp.dxp-comments .comment-hint{margin:.5rem 0}div.dxp.dxp-comments .comment-list{margin-top:1.25rem}"}};export{a as dxp_comments};